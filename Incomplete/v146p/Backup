FROM scimulate/code_aster:14.6

# Install Prerequisites
# Source: https://hitoricae.com/2020/10/31/code_aster-14-6-parallel-version-with-petsc/

RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    gfortran \
    cmake \
    python3 \
    python3-dev \
    python3-numpy \
    tk \
    tcl \
    bison \
    flex \
    liblapack-dev \
    libblas-dev \
    libboost-numpy-dev \
    libboost-all-dev \
    zlib1g-dev \
    checkinstall \
    openmpi-bin \
    libx11-dev \
    grace \
    gettext \
    swig \
    superlu-dev

RUN apt-get update && apt-get install -y \
    gfortran \
    g++ \
    python-dev \
    python-numpy \
    liblapack-dev \
    libblas-dev \
    tcl \
    tk \
    zlib1g-dev \
    bison \
    flex \
    checkinstall \
    openmpi-bin \
    libx11-dev \
    cmake \
    grace \
    gettext \
    libboost-all-dev \
    swig \
    libsuperlu-dev

# Download, Extract code_aster Source Code
WORKDIR /tmp
RUN wget https://www.code-aster.org/FICHIERS/aster-full-src-14.6.0-1.noarch.tar.gz
RUN tar xzvf aster*
WORKDIR /tmp/aster-full-src-14.6.0

# Step 1: Compile OpenBLAS
WORKDIR /tmp
RUN wget https://github.com/xianyi/OpenBLAS/archive/refs/tags/v0.2.20.tar.gz
RUN tar xzvf v0.2.20.tar.gz
WORKDIR /tmp/OpenBLAS-0.2.20
#RUN make TARGET=NEHALEM
RUN make TARGET=HASWELL NO_AFFINITY=1 USE_OPENMP=1
RUN make PREFIX=/opt/OpenBLAS install
#RUN echo /opt/OpenBLAS/lib | sudo tee -a /etc/ld.so.conf.d/openblas.conf
#RUN ldconfig

cd OpenBLAS-0.3.9 &&     make TARGET=CORE2 DYNAMIC_ARCH=1 DYNAMIC_OLDER=1 USE_THREAD=0 USE_OPENMP=0 FC=gfortran CC=gcc COMMON_OPT="-O3 -g -fPIC" FCOMMON_OPT="-O3 -g -fPIC -frecursive" NMAX="NUM_THREADS=128" LIBPREFIX="libopenblas" LAPACKE="NO_LAPACKE=1" INTERFACE64=0 NO_STATIC=1 &&     make -j4 PREFIX=/usr NO_STATIC=1 install &&     cd .. && rm -rf OpenBLAS-0.3.9 && rm v0.3.9.tar.gz # buildkit
